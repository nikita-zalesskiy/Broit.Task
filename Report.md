# Решение тестового задания

Обозначим за $x$ выигрыш игрока за одно вращение без учёта бесплатных вращений. Выигрыш $x$ как случайная величина представляет собой сумму выигрышей по каждой из линий выплат $l(i)$, $0 \leqslant i \leqslant 8$:

$$x = \sum\limits_{i} l(i).$$



Для подсчёта количества конфигураций, при которых имеет место тот или иной выигрыш, удобно разбить случайные величины $l_{i}$ по следующим параметрам:

1. Выпавший символ на линии; 
2. Конфигурация символов на линии.

Всего существует 5 выплачиваемых конфигураций символов на линии:

1. Первые 3;
2. Последние 3;
3. Первые 4;
4. Последние 4;
5. Все 5 символов.

Множество всех символов будем обозначать за $\mathrm{S}$, а множество всех конфигураций за $\mathrm{C}$. Тогда имеем представление

$$x = \sum\limits_{i, s, c} l(i, s, c),$$

где $l(i, s, c)$ указывает на выигрыш по линии $l(i)$ с символом $s \in \mathrm{S}$ и конфигурации $c \in \mathrm{C}$.

Разделим конечную задачу на две части:

1. Расчёт математического ожидания и дисперсии $x$;
2. Использование полученных значений для поиска конечного ответа. 

## Математическое ожидание $x$

Барабанная лента состоит из 180 символов. Из них 10 **W**, 10 **S**, и по 20 копий каждого из 8 обычных символов. Каждый символ на ленте генерирует окно, потому их количество совпадает с количеством символов на ленте. Вероятность выпадения какой-либо конфигурации постоянна и равна

$$p = \dfrac{1}{170^{2}180^{3}}.$$

Математическое ожидание $\mathrm{E}[x]$ является суммой ожиданий $\mathrm{E}[l(i, s, c)]$. Между каждым выигрышем по линии $i$ можно установить взаимооднозначное соответствие с выигрышем по линии $j$ путём сдвига окна барабанов на несколько символов вперёд или назад. Как следствие, можно утверждать о равенстве их математических ожиданий

$$\mathrm{E}[l(i, s, c)] = \mathrm{E}[l(j, s, c)].$$

Каждое конкретное $\mathrm{E}[l(i, s, c)]$ можно представить как следующее произведение:

$$\mathrm{E}[l(i, s, c)] = p\cdot p(s, c)\cdot k(c),$$

где $p(s, c)$ указывает на выигрыш при конфигурации $c$ для символа $s$, а $k(c)$ — количество состояний слота с конфигурацией выигрышей $c$. В нашем случае можно представить $p(s, c)$ как произведение $p_{3}(s)$ выигрыша за три символа и множитель $m(c)$, равный 1, 5 или 10, который зависит только от конфигурации. Имеем следующее представление:

$$\begin{align*}
   \mathrm{E}[x] &= \sum\limits_{i, s, c} \mathrm{E}[l(i, s, c)] \\
   &= 9\sum\limits_{s, c} \mathrm{E}[l(0, s, c)] \\
   &= p \cdot 9 \sum\limits_{s} p_{3}(s) \sum\limits_{c} m(c)k(c) \\
   &= p \cdot 9 \cdot 11 \sum\limits_{c} m(c)k(c)
\end{align*}$$

Значение $k(c)$ найти несложно. Приведу пример его расчёта для первой линии и первой конфигурации $c_{1}$ [первые три символа]. Имеем:

1. На первом барабане есть только 20 символов, которые нам подходят;
2. Во втором и третьем окне имеется 30 подходящих символов, 10 из которых **W**;
3. Четвёртый символ должен быть любым, кроме **W** и нами выбранного обычного. Их количество будет равно 150;
4. Здесь мы выбираем любой символ из 170.

Таким образом, $k(c_{1}) = 20\cdot 30\cdot 30\cdot 150\cdot 170$. Аналогично считаются значения и для других конфигураций. Среднее значение $x$ будет равно

$$\mathrm{E}[x] = \dfrac{55}{51} = 1.0784313725\dots$$

## Дисперсия $x$

Дисперсию $x$ будем находить по формуле

$$\mathrm{D}[x] = \mathrm{E}[x^{2}] - \mathrm{E}[x]^{2}.$$

Значение $\mathrm{E}[x]$ уже известно, потому осталось найти $\mathrm{E}[x^{2}]$. Распишем последнее выражение подробнее:

$$\begin{align*}
\mathrm{E}[x^{2}] &= \sum\limits_{\substack{i_{1}, s_{1}, c_{1} \\ i_{2}, s_{2}, c_{2}}} \mathrm{E}[l(i_{1}, s_{1}, c_{1})l(i_{2}, s_{2}, c_{2})]
\end{align*}$$

Выражение $l(i_{1}, s_{1}, c_{1})l(i_{2}, s_{2}, c_{2})$ отлично от нуля лишь в случае, когда у нас имеется выигрыш одновременно под двум линиям $l(i_{1}), l(i_{2})$ с конкретными символами $s_{1}, s_{2}$ и конфигурациями $c_{1}, c_{2}$ соотвественно. Количество состояний слота с такими параметрами будет обозначаться $k(i_{1}, s_{1}, c_{1}, i_{2}, s_{2}, c_{2})$. В данном случае математическое ожидание можно представить как

$$\mathrm{E}[l(i_{1}, s_{1}, c_{1})l(i_{2}, s_{2}, c_{2})] = p\cdot p(s_{1}, c_{1})\cdot p(s_{2}, c_{2})\cdot k(i_{1}, s_{1}, c_{1}, i_{2}, s_{2}, c_{2}).$$

Значение $k(i_{1}, s_{1}, c_{1}, i_{2}, s_{2}, c_{2})$ считается аналогично предыдущему разделу через произведение количества подходящих окон. Но сейчас на одно окно накладывается два ограничения, каждое из которых имеет следующую формулировку: для позиции $r \in \{0, 1, 2\}$ в окне в отношение символа $s$ должно выполняться одно из трёх условий $e$:

1. Символ на позиции $r$ должен сочетаться с $s$ [то есть быть равным или **W**];
2. Символ на позиции $r$ не должен сочетаться с $s$;
3. Никаких ограничение на позицию $r$ нет.

Приведу пример для понимания. Для подсчёта количества состояний при которых есть выигрыш в три символа **A** по верхней полосе и три символа **B** справа по средней полосе, то следует найти:

1. Сколько окон первого барабана содержит символ **A** на нулевой позиции;
2. Сколько окон второго барабана содержит символ **A** на нулевой позиции, но **не** содержит символа **B** или **W** на первой позиции;
3. Сколько окон третьего барабана содержит символ **A** на нулевой позиции и символ **B** или **W** на первой позиции;
4. Сколько окон четвертого барабана **не** содержит символ **A** на нулевой позиции и символ **B** или **W** на первой позиции;
5. Сколько окон пятого барабана содержит символ **B** на первой позиции.

Произведение рассчитанных значений даст требуемое количество состояний. 

На одно окно сразу накладывается два ограничения с позициями $r_{1}$, $r_{2}$, символами $s_{1}, s_{2}$ и условиями $e_{1}$, $e_{2}$ соответственно. Сгруппировав значения по символам в таблицу $8\times 8$, которая зависит от двух пар параметров $(r_{1}, e_{1})$ и $(r_{2}, e_{2})$, мы получаем по $81 = 3^4$ таблиц для каждой из двух лент барабанов. Просчитав все таблицы заранее, мы можем мгновенно найти значение $\mathrm{E}[l(i_{1}, s_{1}, c_{1})l(i_{2}, s_{2}, c_{2})]$. В виду большого объёма вычислений, был написан небольшой проект на C#, реализующий описанный алгоритм. Как результат, имеем

$$\begin{align*}
   \mathrm{E}[x^{2}] &= \dfrac{133478304427}{8778375000} \\[2ex]
   \mathrm{D}[x] &= \dfrac{123268929427}{8778375000} = 14.0423403451\dots \\
\end{align*}$$

## Моменты выигрыша с бесплатными вращениями

Обозначим за $y_{i}$, $i \geqslant 0$ выигрыш игрока за $i$-ое вращение и последующих за ним бесплатных вращений. В виду независимости вращений, имеем

$$\mathrm{E}[y_{i}] = \mathrm{E}[y_{j}].$$

При этом мы можем записать $y=y_{0}$ как

$$\begin{align*}
y &= x + \mathbf{1}(\mathrm{S}_{3})\sum\limits_{i=1}^{5} y_{i} \\
&+ \mathbf{1}(\mathrm{S}_{4})\sum\limits_{i=1}^{10} y_{i} \\
&+ \mathbf{1}(\mathrm{S}_{5})\sum\limits_{i=1}^{15} y_{i},
\end{align*}$$

где $\mathrm{S}_{i}$ указывает на событие о выпадении ровно $i$ символов **S**. Если взять математическое ожидание от обеих частей, то получим

$$\mathrm{E}[y] = \dfrac{\mathrm{E}[x]}{1-5\mathrm{P}[\mathrm{S}_{3}]-10\mathrm{P}[\mathrm{S}_{4}]-15\mathrm{P}[\mathrm{S}_{5}]}.$$

Вероятности $\mathrm{P}[\mathrm{S}_{i}]$ считаются руками. Ниже представлены уже полученные значения:

$$\begin{align*}
\mathrm{P}[\mathrm{S}_{3}] &= \dfrac{225271}{6242400} = 0.0360872420\dots \\[2ex]
\mathrm{P}[\mathrm{S}_{4}] &= \dfrac{28211}{6242400} = 0.0045192554\dots \\[2ex]
\mathrm{P}[\mathrm{S}_{5}] &= \dfrac{1981}{6242400} = 0.0003173458\dots
\end{align*}$$

Так мы получаем результат для первого момента:

$$\mathrm{E}[y] = \dfrac{336600}{240211} = 1.4012680518\dots$$

Дисперсию $y$ будем вычислять аналогично предыдущему разделу. Заметим, что множества $\mathrm{S}_{i}$ попарно не пересекаются, оттого произведение их индикаторов будет тождественно равно нулю. Имеем

$$\begin{align*}
\mathrm{E}[y^{2}] &= \mathrm{E}[x^{2}] \\
&+ 10\mathrm{E}[x\mathbf{1}(\mathrm{S}_{3})]\mathrm{E}[y] \\
&+ 20\mathrm{E}[x\mathbf{1}(\mathrm{S}_{4})]\mathrm{E}[y] \\
&+ 30\mathrm{E}[x\mathbf{1}(\mathrm{S}_{5})]\mathrm{E}[y] \\
&+ \mathrm{P}[\mathrm{S}_{3}](5\mathrm{E}[y^{2}] + 10\mathrm{E}[y]^{2}) \\ &+ \mathrm{P}[\mathrm{S}_{4}](10\mathrm{E}[y^{2}] + 90\mathrm{E}[y]^{2}) \\ &+ \mathrm{P}[\mathrm{S}_{5}](15\mathrm{E}[y^{2}] + 210\mathrm{E}[y]^{2})
\end{align*}$$

Величины $\mathrm{E}[x\mathbf{1}(\mathrm{S}_{i})]$ рассчитываются по примеру предыдущего раздела. Полученные через программу значения имеют вид:
$$\begin{align*}
\mathrm{E}[x\mathbf{1}(\mathrm{S}_{3})] &= \dfrac{96281321}{5267025000} = 0.0182800197\dots \\[2ex]
\mathrm{E}[x\mathbf{1}(\mathrm{S}_{4})] &= \dfrac{68700707}{42136200000} = 0.0016304438\dots  \\[2ex]
\mathrm{E}[x\mathbf{1}(\mathrm{S}_{5})] &= \dfrac{237103}{3098250000} = 0.0000765280\dots
\end{align*}$$

Разрешая уравнение выше относительно $\mathrm{E}[y^{2}]$, выводим следующие равенства

$$\begin{align*}
\mathrm{E}[y^{2}] &= \dfrac{8686128068305896969967}{389826361814454309375} = 22.2820437999\dots \\[2ex]
\mathrm{D}[y] &= \dfrac{7920683676229521969967}{389826361814454309375} = 20.3184916468\dots
\end{align*}$$